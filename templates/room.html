{% extends 'base.html' %}
{% block content %}
<div class="flex h-screen overflow-hidden">

  <!-- Sidebar (Room Info) -->
  <div class="w-80 glass border-r border-gray-700 flex flex-col hidden md:flex">
    <div class="p-6 border-b border-gray-700">
      <h2 class="text-xl font-bold flex items-center">
        <i class="fas fa-comments text-blue-500 mr-3"></i>
        Room: <span class="font-mono ml-2 text-blue-400">{{code}}</span>
      </h2>
    </div>

    <div class="flex-grow p-6 overflow-y-auto">
      <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-4">Active Users</h3>
      <!-- This could be dynamic if we tracked online users properly -->
      <div class="space-y-3" id="active-users-list">
        <!-- Dynamic content -->
      </div>
    </div>

    <div class="p-4 border-t border-gray-700">
      <a href="{{ url_for('home') }}"
        class="block w-full py-2 px-4 bg-red-500/20 hover:bg-red-500/30 text-red-400 text-center rounded-lg transition text-sm font-semibold">
        Leave Room
      </a>
    </div>
  </div>

  <!-- Main Chat Area -->
  <div class="flex-grow flex flex-col relative">
    <!-- Mobile Header -->
    <div class="md:hidden glass p-4 border-b border-gray-700 flex justify-between items-center z-10">
      <span class="font-bold">Room: {{code}}</span>
      <a href="{{ url_for('home') }}" class="text-red-400"><i class="fas fa-sign-out-alt"></i></a>
    </div>

    <!-- Messages -->
    <div class="flex-grow overflow-y-auto p-6 space-y-4" id="messages">
      <!-- Messages will be injected here -->
    </div>

    <!-- Input Area -->
    <div class="glass p-4 border-t border-gray-700">
      <div class="max-w-4xl mx-auto flex space-x-4">
        <input type="text" id="message" placeholder="Type your message..."
          class="flex-grow px-4 py-3 rounded-full bg-gray-800 border border-gray-700 text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition"
          onkeypress="if(event.key === 'Enter') sendMessage()">
        <button onclick="sendMessage()"
          class="w-12 h-12 rounded-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white shadow-lg flex items-center justify-center transform hover:scale-110 transition">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

</div>

<script type="text/javascript">
  var socketio = io();
  const messages = document.getElementById("messages");

  const createMessage = (name, msg) => {
    const isMe = name === "{{ session['username'] }}"; // Simple check, might need better ID check
    const align = isMe ? "justify-end" : "justify-start";
    const bg = isMe ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-200";
    const rounded = isMe ? "rounded-br-none" : "rounded-bl-none";

    const content = `
      <div class="flex ${align} mb-4 animate-fade-in-up">
        <div class="max-w-[70%]">
          <div class="text-xs text-gray-400 mb-1 ${isMe ? 'text-right' : 'text-left'}">${name}</div>
          <div class="px-4 py-2 rounded-2xl ${rounded} ${bg} shadow-md break-words">
            ${msg}
          </div>
          <div class="text-[10px] text-gray-500 mt-1 ${isMe ? 'text-right' : 'text-left'}">
            ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
          </div>
        </div>
      </div>
    `;
    messages.innerHTML += content;
    messages.scrollTop = messages.scrollHeight;
  };

  socketio.on("message", (data) => {
    createMessage(data.name, data.message);
  });

  socketio.on("update_users", (data) => {
    const list = document.getElementById("active-users-list");
    list.innerHTML = "";

    data.users.forEach(user => {
      const isMe = user === "{{ session['username'] }}";
      const bg = isMe ? "bg-green-500" : "bg-gray-600";
      const label = isMe ? "YOU" : user.substring(0, 2).toUpperCase();
      const name = isMe ? "You" : user;

      const item = `
        <div class="flex items-center space-x-3 p-2 rounded-lg bg-white/5 animate-fade-in-up">
          <div class="w-8 h-8 rounded-full ${bg} flex items-center justify-center text-xs font-bold">
            ${label}
          </div>
          <span class="text-sm font-medium">${name}</span>
        </div>
      `;
      list.innerHTML += item;
    });
  });

  const sendMessage = () => {
    const message = document.getElementById("message");
    if (message.value == "") return;
    socketio.emit("message", { data: message.value });
    message.value = "";
  };

  // Load existing messages
  {% for msg in messages %}
  createMessage("{{msg.name}}", "{{msg.message}}");
  {% endfor %}
</script>

<style>
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in-up {
    animation: fadeInUp 0.3s ease-out forwards;
  }
</style>
{% endblock %}